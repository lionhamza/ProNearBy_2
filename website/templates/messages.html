{% extends "base.html" %}
{% block title %}Messages{% endblock %}

{% block div %}
<div class="chat-container">
  <!-- User List -->
<div id="userList" class="user-list">
  <h3>Chats</h3>
  {% for user in users %}
    <a href="{{ url_for('views.messages', user_id=user.ID) }}" class="chat-user {% if selected_user and user.ID == selected_user.ID %}active{% endif %}">
      {{ user.Name }} {{ user.Surname }}
      {% if unread_counts[user.ID] > 0 %}
        <span class="unread-badge">{{ unread_counts[user.ID] }}</span>
      {% endif %}
    </a>
  {% endfor %}
</div>

  <!-- Chat Box -->
  <div id="chatBox" class="chat-box {% if selected_user %}active{% endif %}">
    {% if selected_user %}
      <a href="#" class="back-link" onclick="goBackToList()">‚Üê Back</a>
      <h3>Chat with {{ selected_user.Name }}</h3>
      <div class="message-history">
        {% for msg in messages %}
          <div class="{% if msg.sender_id == session['user_id'] %}sent{% else %}received{% endif %}">
            <p>{{ msg.content }}</p>
            <span>{{ msg.timestamp.strftime('%Y-%m-%d %H:%M') }}</span>
          </div>
        {% endfor %}
      </div>
      <form method="POST" class="message-form">
        <input type="text" name="message" placeholder="Type your message..." required />
        <button type="submit">Send</button>
      </form>
    {% else %}
      <p>Select a user to start chatting.</p>
    {% endif %}
  </div>
</div>


<!-- JavaScript to control mobile view toggle -->
<script>
  document.addEventListener("DOMContentLoaded", function () {
    const isMobile = window.innerWidth <= 768;
    const userList = document.getElementById("userList");
    const chatBox = document.getElementById("chatBox");
    const selectedUser = {{ 'true' if selected_user else 'false' }};

    if (isMobile) {
      if (selectedUser) {
        userList.style.display = "none";
        chatBox.classList.add("active");
      } else {
        chatBox.classList.remove("active");
        chatBox.style.display = "none";
      }
    }
  });

  function goBackToList() {
    document.getElementById("chatBox").classList.remove("active");
    document.getElementById("chatBox").style.display = "none";
    document.getElementById("userList").style.display = "block";
  }
</script>


{% endblock %}
