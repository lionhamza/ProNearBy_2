{% extends "base.html" %}

{% block title %}Home - ProNearBy{% endblock %}

{% block div %}
<div class="main-layout">
  <!-- Sidebar -->
  <aside class="sidebar">
    
  {% if user.user_type == 'regular' %}
    <img src="{{ url_for('static', filename=user.Image or 'assets/defualtPP.png') }}" alt="Profile Picture" class="profile-pic" />
    <h2 class="username"><span>{{ user.Name }}</span> <span>{{ user.Surname }}</span></h2>

    {% if user.Email %}
      <p><strong>Email:</strong> {{ user.Email }}</p>
    {% endif %}
    {% if user.CellPhone %}
      <p><strong>Contact:</strong> {{ user.CellPhone }}</p>
       <!-- Become a Pro button -->
        <hr/>
      <button class="view-profile-btn">Edit Contact Info</button>
      <a href="{{ url_for('auth.choose_pro_type') }}" class="browse-pros-btn">
      <i class="fas fa-stream"></i> Become a Pro
    </a>
    {% endif %}

  {% else %}
    <img src="{{ url_for('static', filename=user.Image or 'assets/defualtPP.png') }}" alt="Profile Picture" class="profile-pic" />
    <h2 class="username"><span>{{ user.Name }}</span> <span>{{ user.Surname }}</span></h2>
    <p class="role">{{ user.Service }}</p>
    <p class="bio">{{ user.Bio }}</p>
    <hr />
    <p><strong>Location:</strong> {{ user.Location }}</p>
    <p><strong>Experience:</strong> {{ user.Experience }}</p>
    <p><strong>Availability:</strong> {{ user.availability }}</p>
    <p><strong>Rating:</strong> ⭐ {{ user.Rating }} ({{ user.Reviews }} reviews)</p>
    <hr class="sidebar-divider" />
    <a href="{{ url_for('views.profile', user_id=user.ID) }}" class="view-profile-btn">View Profile</a>
  {% endif %}
</aside>


  <!-- Cards -->
  <section class="content-section">
    <!-- Example of a single card -->
    <div class="apost">
  {% for post in posts %}
  {% set post_user = post.user %}
  <div class="post-card">
    <div class="post-header">
      <img src="{{ url_for('static', filename=post_user.Image or 'assets/defualtPP.png') }}" class="post-profile-pic" alt="User Pic">
      <div class="post-user-info">
  <a href="{{ url_for('views.profile', user_id=post_user.ID) }}" class="post-user-name">
  {{ post_user.Name }} {{ post_user.Surname }}
</a>

  <span class="post-timestamp">{{ post.timestamp.strftime('%b %d, %Y %H:%M') }}</span>
</div>

      <div class="post-options">⋮</div>
    </div>

    <div class="post-body">
      <p>{{ post.content }}</p>
       {% if post.media %}
<div class="media-grid {% if post.media|length == 1 %}single-media{% elif post.media|length == 3 %}three-media{% endif %}">

    {% set max_visible = 4 %}
    {% set extra_count = post.media|length - max_visible %}
    {% for file in post.media %}
        {% if loop.index0 < max_visible %}
            {% if file.endswith(('.png', '.jpg', '.jpeg', '.gif')) %}
                <div class="media-wrapper">
                    <img src="{{ url_for('static', filename=file) }}"
                         class="media-item"
                         alt="Image"
                         onclick='openLightbox({{ post.media|tojson|safe }}, {{ loop.index0 }})'>
                    {% if loop.index0 == max_visible - 1 and extra_count > 0 %}
                        <div class="overlay">+{{ extra_count }}</div>
                    {% endif %}
                </div>
            {% elif file.endswith(('.mp4', '.mov', '.avi', '.webm')) %}
                <div class="media-wrapper">
                    <video controls class="media-item"
                           onclick='openLightbox({{ post.media|tojson|safe }}, {{ loop.index0 }})'>
                        <source src="{{ url_for('static', filename=file) }}">
                    </video>
                    {% if loop.index0 == max_visible - 1 and extra_count > 0 %}
                        <div class="overlay">+{{ extra_count }}</div>
                    {% endif %}
                </div>
            {% endif %}
        {% endif %}
    {% endfor %}
</div>
{% endif %}
</div>

    <div class="post-actions">
  <form action="{{ url_for('views.like_post', post_id=post.id) }}" method="POST">

    {% set liked = post.likes.filter_by(user_id=session.get('user_id')).first() %}
<!-- Assume post.id is available and unique -->
<button class="like-button" data-post-id="{{ post.id }}">
  <img
  src="{{ url_for('static', filename='assets/LikeP.png') if post.id in liked_post_ids else url_for('static', filename='assets/like.png') }}"
  class="like-icon"
  id="like-icon-{{ post.id }}"
  alt="Like"
/>

</button>
<span id="like-count-{{ post.id }}">{{ post.like_count }}</span>

  </form>
</div>

  </div>
  {% endfor %}
</div>

    <!-- Copy the above div and change content for more cards -->
  </section>
  
  {% if user.ID == session.get('user_id') and user.user_type == 'regular' %}
<!-- Edit Contact Info Modal -->
<div id="editContactModal" class="modal">
  <div class="modal-content">
    <span class="close" id="closeContactModal">&times;</span>
   
<form action="{{ url_for('views.update_contact', user_id=user.ID) }}" method="POST" class="edit-form" enctype="multipart/form-data">
  <h3>Edit Contact Info</h3>

  <label for="email">Email:</label>
  <input type="email" name="email" id="email" value="{{ user.Email }}" required>
  <div class="error-message" id="email-error">Invalid email format.</div>

  <label for="cellphone">Cell Phone:</label>
  <input type="text" name="cellphone" id="cellphone" value="{{ user.CellPhone }}" required>
  <div class="error-message" id="phone-error">Invalid phone number format.</div>

  <label for="profile_pic">Profile Picture:</label>
  <input type="file" name="profile_pic" id="profile_pic" accept="image/*">

  <button type="submit" class="save-btn">Save</button>
</form>

  </div>
</div>
{% endif %}

<div id="lightbox" class="lightbox">
      <button class="nav-btn left" onclick="prevMedia()">&#10094;</button>
      <img id="lightbox-img" src="" alt="Full View">
      <video id="lightbox-video" controls style="display:none;"></video>
      <button class="nav-btn right" onclick="nextMedia()">&#10095;</button>
      <span class="close" onclick="closeLightbox()">&times;</span>
  </div>
</div>

<script>
  // Automatically fade out flash messages after 1 second
  setTimeout(() => {
    const container = document.getElementById("flash-container");
    if (container) {
      container.style.transition = "opacity 0.5s ease";
      container.style.opacity = 0;
      setTimeout(() => container.remove(), 500);  // fully remove from DOM
    }
  }, 1000);
</script>
<script>
  document.addEventListener("DOMContentLoaded", () => {
    const modal = document.getElementById("editContactModal");
    const closeBtn = document.getElementById("closeContactModal");
    const openBtn = document.querySelector(".view-profile-btn"); // "Edit Contact Info" button

    if (openBtn) {
      openBtn.onclick = () => {
        modal.style.display = "block";
      };
    }

    if (closeBtn) {
      closeBtn.onclick = () => {
        modal.style.display = "none";
      };
    }

    window.onclick = (e) => {
      if (e.target === modal) {
        modal.style.display = "none";
      }
    };
  });
</script>
<script>
  document.getElementById('email').addEventListener('input', function() {
    const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
    const error = document.getElementById('email-error');
    if (emailRegex.test(this.value)) {
      this.classList.remove('invalid');
      this.classList.add('valid');
      error.style.display = 'none';
    } else {
      this.classList.add('invalid');
      this.classList.remove('valid');
      error.style.display = 'block';
    }
  });

  document.getElementById('cellphone').addEventListener('input', function() {
    const phoneRegex = /^\+?[0-9]{10,11}$/;
    const error = document.getElementById('phone-error');
    if (phoneRegex.test(this.value)) {
      this.classList.remove('invalid');
      this.classList.add('valid');
      error.style.display = 'none';
    } else {
      this.classList.add('invalid');
      this.classList.remove('valid');
      error.style.display = 'block';
    }
  });
</script>
{% endblock %}