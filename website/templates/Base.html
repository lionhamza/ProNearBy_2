<!DOCTYPE html> 
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>{% block title %}ProNearBy{% endblock %}</title>
  <link rel="stylesheet" href="{{ url_for('static', filename='home.css') }}">
  <link rel="stylesheet" href="{{ url_for('static', filename='feed.css') }}">
  <link rel="stylesheet" href="{{ url_for('static', filename='chat.css') }}">
  
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css">
  <link rel="icon" href="{{ url_for('static', filename='assets/favicon.ico') }}" type="image/x-icon" />
  
</head>
<body>
  <header>
  <div class="header-container">

    <!-- Logo on far left -->
    <a href="{{ url_for('views.Base') }}" class="logo-link">
      <img src="{{ url_for('static', filename='assets/favicon.ico') }}" alt="ProNearBy Logo" class="logo-icon" />
    </a>

    <!-- Search form in center -->
    <form class="search-form" method="GET" action="{{ url_for('views.mock_feed') }}">
  <!-- Always visible -->
  <input
    type="text"
    class="header-search-input"
    name="search"
    placeholder="Search for a Pro..."
    value="{{ request.args.get('search', '') }}"
    onclick="showMobileSearch()"
  />

  <!-- Hidden on small screens -->
  <div class="location-search-wrapper" id="locationSearch">
    <input
      type="text"
      class="header-search-input location-input"
      name="location"
      placeholder="Which location..."
      value="{{ request.args.get('location', '') }}"
    />
    <button type="submit" class="header-search-button">Search</button>
  </div>
</form>


    <!-- Nav links -->
    <div class="nav-links">
      <a href="{{ url_for('views.Base') }}" class="nav-link">Home</a>
      <a href="{{ url_for('views.mock_feed') }}" class="nav-link">
          <i class="fas fa-stream"></i> Professional Feed
        </a>
    </div>

    <!-- Icons and notification -->
    <!-- Icons and notification -->
<div class="icons-container">

  <!-- Messages with badge -->
  <a href="{{ url_for('views.messages') }}" class="icon-badge">
    <img src="{{ url_for('static', filename='assets/message.png') }}" alt="Messages" class="header-icon" />
    {% if unread_messages_count and unread_messages_count > 0 %}
      <span class="badge">{{ unread_messages_count }}</span>
    {% endif %}
  </a>

  <!-- Notifications with badge -->
  <div class="notification-wrapper icon-badge">
    <img src="{{ url_for('static', filename='assets/notification.png') }}" alt="Notifications" class="header-icon" id="notificationBell" />
    {% if pending_requests_count and pending_requests_count > 0 %}
      <span class="badge">{{ pending_requests_count }}</span>
    {% endif %}

    <div class="notification-dropdown" id="notificationDropdown">
      <h4>New Requests</h4>
      {% if service_requests %}
        {% for request in service_requests %}
          <div class="notification-item">
            <strong>{{ request.sender.Name }} {{ request.sender.Surname }}</strong><br>
            <small>
              {{ request.service_type }} |
              {% if request.preferred_date %}{{ request.preferred_date.strftime('%Y-%m-%d') }}{% endif %}
              {% if request.preferred_time %} at {{ request.preferred_time.strftime('%H:%M') }}{% endif %}
            </small>
            <div class="notification-actions">
              <form method="POST" action="{{ url_for('views.accept_request', request_id=request.id) }}" style="display:inline;">
                <button type="submit" class="accept-btn">Accept</button>
              </form>
              <form method="POST" action="{{ url_for('views.decline_request', request_id=request.id) }}" style="display:inline;">
                <button type="submit" class="decline-btn">Decline</button>
              </form>
            </div>
          </div>
        {% endfor %}
      {% else %}
        <p class="no-notifications">No new requests</p>
      {% endif %}
    </div>
  </div>

  <!-- Logout -->
  <a href="{{ url_for('auth.logout') }}" class="icon-link logout-icon">
    <i class="fas fa-sign-out-alt"></i>
  </a>
</div>



      <!-- Mobile hamburger -->
      <div class="mobile-menu-icon" onclick="toggleMobileMenu()">
        <i class="fas fa-bars"></i>
      </div>

  </div>
</header>

<div class="mobile-menu" id="mobileMenu">
  <a href="{{ url_for('views.Base') }}">Home</a>
  <a href="{{ url_for('views.mock_feed') }}">Professional Feed</a>
  <a href="{{ url_for('views.messages') }}">Messages</a>
  <a href="#" onclick="toggleMobileNotificationDropdown()">Notifications</a>
  
  {% if user %}
    {% if user.user_type == 'regular' %}
        <a href="{{ url_for('views.regular_profile', user_id=user.ID) }}">My Profile</a>
    {% else %}
        <a href="{{ url_for('views.profile', user_id=user.ID) }}">My Profile</a>
    {% endif %}
  {% endif %}
  <a href="{{ url_for('auth.logout') }}">Logout</a>
</div>

<!-- Mobile Notification Dropdown -->
<div class="mobile-notification-dropdown" id="mobileNotificationDropdown" style="display: none;">
  <h4>New Requests</h4>
  {% if service_requests %}
    {% for request in service_requests %}
      <div class="notification-item">
        <strong>{{ request.sender.Name }} {{ request.sender.Surname }}</strong><br>
        <small>
          {{ request.service_type }} |
          {% if request.preferred_date %}{{ request.preferred_date.strftime('%Y-%m-%d') }}{% endif %}
          {% if request.preferred_time %} at {{ request.preferred_time.strftime('%H:%M') }}{% endif %}
        </small>
        <div class="notification-actions">
          <form method="POST" action="{{ url_for('views.accept_request', request_id=request.id) }}" style="display:inline;">
            <button type="submit" class="accept-btn">Accept</button>
          </form>
          <form method="POST" action="{{ url_for('views.decline_request', request_id=request.id) }}" style="display:inline;">
            <button type="submit" class="decline-btn">Decline</button>
          </form>
        </div>
      </div>
    {% endfor %}
  {% else %}
    <p class="no-notifications">No new requests</p>
  {% endif %}
</div>


{% with messages = get_flashed_messages(with_categories=true) %}
  {% if messages %}
    <div class="flash-messages" id="flash-container">
     {% for category, message in messages %}
      <div class="flash-message {{ category }}">{{ message }}</div>
      {% endfor %}
    </div>

  {% endif %}
{% endwith %}
  {% block div %}{% endblock %}
  <!-- END OF MAIN CONTENT -->

<script>
  function showMobileSearch() {
    const wrapper = document.getElementById("locationSearch");
    wrapper.classList.toggle("show");
  }

  // Close location search when clicking outside
  window.addEventListener("click", function (e) {
    const searchInput = document.querySelector(".header-search-input");
    const locationWrapper = document.getElementById("locationSearch");

    // If search is open, and click is outside both input and wrapper, close it
    if (
      locationWrapper.classList.contains("show") &&
      !searchInput.contains(e.target) &&
      !locationWrapper.contains(e.target)
    ) {
      locationWrapper.classList.remove("show");
    }
  });

  // Prevent clicks inside search form from triggering outside close
  document.querySelector(".search-form").addEventListener("click", function (e) {
    e.stopPropagation();
  });
</script>
<script>
  document.addEventListener('DOMContentLoaded', function () {
    const mobileDropdown = document.getElementById('mobileNotificationDropdown');
    const mobileToggleLink = document.querySelector('a[onclick="toggleMobileNotificationDropdown()"]');

    // 1. Toggle dropdown when "Notifications" link is clicked
    mobileToggleLink.addEventListener('click', function (e) {
      e.preventDefault(); // stop the <a> navigation
      e.stopPropagation(); // prevent bubbling
      mobileDropdown.style.display = mobileDropdown.style.display === 'block' ? 'none' : 'block';
    });

    // 2. Close when clicking outside
    document.addEventListener('click', function (e) {
      if (!mobileDropdown.contains(e.target) && !mobileToggleLink.contains(e.target)) {
        mobileDropdown.style.display = 'none';
      }
    });

    // 3. Close when clicking a notification item
    // 3. Close when clicking a notification item
mobileDropdown.addEventListener('click', function (e) {
  if (e.target.classList.contains('notification-item') || e.target.closest('.notification-item')) {
    mobileDropdown.style.display = 'none';

    // Also close the mobile menu
    const mobileMenu = document.getElementById('mobileMenu');
    mobileMenu.classList.remove('show');
  }
});


  });
</script>
<!-- Lightbox -->


<style>
.nav-btn {
  position: absolute;
  top: 50%;
  transform: translateY(-50%);
  background: rgba(0,0,0,0.5);
  color: white;
  border: none;
  font-size: 2rem;
  padding: 0 10px;
  cursor: pointer;
  z-index: 10000;
}

.nav-btn.left { left: 10px; }
.nav-btn.right { right: 10px; }

.lightbox {
  display: none; /* hide initially */
  position: fixed;
  z-index: 9999;
  left: 0; 
  top: 0;
  width: 100%; 
  height: 100%;
  background: rgba(0,0,0,0.9);
  flex-direction: column;
  justify-content: center;
  align-items: center;
}

.lightbox img, .lightbox video {
  max-width: 90%;
  max-height: 90%;
  border-radius: 8px;
}/* Base grid (keep once) */
.media-grid {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
  gap: 8px;
}

/* Single item fills width */
.media-grid.single-media {
  grid-template-columns: 1fr;
}
.media-grid.single-media .media-wrapper img,
.media-grid.single-media .media-wrapper video {
  width: 100%;
  height: auto;
  max-height: 80vh;
  object-fit: contain;
}

/* Exactly 3 items: make a mosaic without the empty slot */
.media-grid.three-media {
  /* force 2 columns so we can make one tile tall */
  grid-template-columns: 2fr 1fr;   /* big left, small right */
  grid-auto-rows: 140px;            /* FIXED row height so span works */
  grid-auto-flow: dense;            /* pack items tightly, no gaps */
}

/* make the FIRST card tall (fills the “missing 4th” space) */
.media-grid.three-media .media-wrapper:nth-child(1) {
  grid-row: span 2;
}

/* ensure media fills its grid area */
.media-grid.three-media .media-wrapper {
  overflow: hidden;                 /* nice crop */
  border-radius: 8px;
}
.media-grid.three-media .media-wrapper img,
.media-grid.three-media .media-wrapper video {
  width: 100%;
  height: 100%;
  object-fit: cover;                /* cover the tile cleanly */
}



</style>

<script>

let currentMedia = [];
let currentIndex = 0;

function openLightbox(mediaArray, index) {
    currentMedia = mediaArray;
    currentIndex = index;
    showLightbox();
}

function showLightbox() {
    const lb = document.getElementById('lightbox');
    const lbImg = document.getElementById('lightbox-img');
    const lbVideo = document.getElementById('lightbox-video');

    const file = currentMedia[currentIndex];
    const ext = file.split('.').pop().toLowerCase();

    lb.style.display = 'flex';

    if(['mp4','mov','avi','webm'].includes(ext)){
        lbImg.style.display = 'none';
        lbVideo.style.display = 'block';
        lbVideo.src = `/static/${file}`;
        lbVideo.play();
    } else {
        lbVideo.style.display = 'none';
        lbVideo.pause();
        lbImg.style.display = 'block';
        lbImg.src = `/static/${file}`;
    }
}

function closeLightbox() {
    const lbVideo = document.getElementById('lightbox-video');
    lbVideo.pause();
    document.getElementById('lightbox').style.display = 'none';
}

function nextMedia() {
    currentIndex = (currentIndex + 1) % currentMedia.length;
    showLightbox();
}

function prevMedia() {
    currentIndex = (currentIndex - 1 + currentMedia.length) % currentMedia.length;
    showLightbox();
}
</script>

</body>

<script>
  const bell = document.getElementById('notificationBell');
  const dropdown = document.getElementById('notificationDropdown');

  bell.addEventListener('click', () => {
    dropdown.style.display = dropdown.style.display === 'block' ? 'none' : 'block';
  });

  window.addEventListener('click', function(e) {
    if (!bell.contains(e.target) && !dropdown.contains(e.target)) {
      dropdown.style.display = 'none';
    }
  });
</script>
<script>
  // Automatically fade out flash messages after 1 second
  setTimeout(() => {
    const container = document.getElementById("flash-container");
    if (container) {
      container.style.transition = "opacity 0.5s ease";
      container.style.opacity = 0;
      setTimeout(() => container.remove(), 500);  // fully remove from DOM
    }
  }, 1500);
</script>
<script>
  function toggleMobileMenu() {
    const menu = document.getElementById('mobileMenu');
    menu.classList.toggle('show');
  }

  // Close when clicking outside
  window.addEventListener('click', function (e) {
    const menu = document.getElementById('mobileMenu');
    const icon = document.querySelector('.mobile-menu-icon');
    if (!menu.contains(e.target) && !icon.contains(e.target)) {
      menu.classList.remove('show');
    }
  });
</script>

<script>
  function showMobileSearch() {
    const wrapper = document.getElementById("locationSearch");
    wrapper.classList.toggle("show");
  }
</script>
<script>
document.querySelectorAll('.like-button').forEach(button => {
  button.addEventListener('click', async (e) => {
    e.preventDefault();  // prevent form from submitting and reloading the page

    const postId = button.getAttribute('data-post-id');
    const icon = document.getElementById(`like-icon-${postId}`);
    const likeCount = document.getElementById(`like-count-${postId}`);

    const response = await fetch(`/like/${postId}`, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
    });

    const result = await response.json();
    if (result.success) {
      icon.src = result.liked ? '/static/assets/likeP.png' : '/static/assets/like.png';
      likeCount.textContent = result.like_count;
    }
  });
});

</script>
</html>